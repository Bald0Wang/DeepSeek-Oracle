services:
  redis:
    image: redis:7-alpine
    container_name: deepseek-oracle-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: deepseek-oracle-backend
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      DEBUG: "${BACKEND_DEBUG:-false}"
      SECRET_KEY: "${SECRET_KEY:-change-me}"
      CORS_ORIGINS: "${CORS_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}"
      DATABASE_PATH: "/app/data/data.db"
      REDIS_URL: "redis://redis:6379/0"
      ANALYSIS_QUEUE: "${ANALYSIS_QUEUE:-analysis}"
      IZTHON_SRC_PATH: "/opt/izthon/src"
      REQUEST_TIMEOUT_S: "${REQUEST_TIMEOUT_S:-1800}"
      MAX_TASK_RETRY: "${MAX_TASK_RETRY:-2}"
      LLM_MAX_RETRIES: "${LLM_MAX_RETRIES:-2}"
      ORACLE_EAST_ONLY_MVP: "${ORACLE_EAST_ONLY_MVP:-true}"
      LLM_PROVIDER: "${LLM_PROVIDER:-mock}"
      LLM_MODEL: "${LLM_MODEL:-mock-v1}"
      PROMPT_VERSION: "${PROMPT_VERSION:-v1}"
      ARK_API_KEY: "${ARK_API_KEY:-}"
      ARK_API_MODEL: "${ARK_API_MODEL:-}"
      DEEPSEEK_API_KEY: "${DEEPSEEK_API_KEY:-}"
      DEEPSEEK_BASE_URL: "${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}"
      ALIYUN_API_KEY: "${ALIYUN_API_KEY:-}"
      ALIYUN_BASE_URL: "${ALIYUN_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}"
      ZHIPU_API_KEY: "${ZHIPU_API_KEY:-}"
      QWEN_API_KEY: "${QWEN_API_KEY:-}"
      QWEN_BASE_URL: "${QWEN_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}"
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    volumes:
      - backend_data:/app/data
      - "${IZTHON_SRC_PATH_HOST:-../izthon/src}:/opt/izthon/src:ro"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: deepseek-oracle-worker
    restart: unless-stopped
    command: ["python", "worker.py"]
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      DEBUG: "${BACKEND_DEBUG:-false}"
      SECRET_KEY: "${SECRET_KEY:-change-me}"
      CORS_ORIGINS: "${CORS_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}"
      DATABASE_PATH: "/app/data/data.db"
      REDIS_URL: "redis://redis:6379/0"
      ANALYSIS_QUEUE: "${ANALYSIS_QUEUE:-analysis}"
      IZTHON_SRC_PATH: "/opt/izthon/src"
      REQUEST_TIMEOUT_S: "${REQUEST_TIMEOUT_S:-1800}"
      MAX_TASK_RETRY: "${MAX_TASK_RETRY:-2}"
      LLM_MAX_RETRIES: "${LLM_MAX_RETRIES:-2}"
      ORACLE_EAST_ONLY_MVP: "${ORACLE_EAST_ONLY_MVP:-true}"
      LLM_PROVIDER: "${LLM_PROVIDER:-mock}"
      LLM_MODEL: "${LLM_MODEL:-mock-v1}"
      PROMPT_VERSION: "${PROMPT_VERSION:-v1}"
      ARK_API_KEY: "${ARK_API_KEY:-}"
      ARK_API_MODEL: "${ARK_API_MODEL:-}"
      DEEPSEEK_API_KEY: "${DEEPSEEK_API_KEY:-}"
      DEEPSEEK_BASE_URL: "${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}"
      ALIYUN_API_KEY: "${ALIYUN_API_KEY:-}"
      ALIYUN_BASE_URL: "${ALIYUN_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}"
      ZHIPU_API_KEY: "${ZHIPU_API_KEY:-}"
      QWEN_API_KEY: "${QWEN_API_KEY:-}"
      QWEN_BASE_URL: "${QWEN_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}"
    volumes:
      - backend_data:/app/data
      - "${IZTHON_SRC_PATH_HOST:-../izthon/src}:/opt/izthon/src:ro"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: deepseek-oracle-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-8080}:80"

volumes:
  backend_data:
